<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>

    <!-- VENTAS: coloca el bloque DESPUÉS de la última tabla que identifique el TOTAL -->
    <template id="sale_report_iva_block" inherit_id="sale.report_saleorder_document" priority="1012">
      <xpath expr="(//table[.//span[@t-field='o.amount_total'] or .//*[self::td or self::th][contains(normalize-space(), 'Total')]])[last()]" position="after">
        <t t-if="o">
          <style>
            @media screen { .iva16-block { display: none; } }
            @media print  { .iva16-block { display: block; } }
            .iva16-note { font-size: 11px; color: #666; }
            .iva16-table td { padding: 2px 0; }
          </style>

          <div class="iva16-block mt8">
            <t t-set="rate" t-value="0.16"/>
            <t t-set="subtotal" t-value="o.currency_id.round(o.amount_total / (1 + rate))"/>
            <t t-set="iva" t-value="o.currency_id.round(subtotal * rate)"/>
            <t t-set="total" t-value="subtotal + iva"/>

            <p class="mb4"><strong>Resumen (presentación con IVA 16%)</strong></p>
            <table class="table table-sm iva16-table" style="width:100%">
              <tr>
                <td>Subtotal</td>
                <td class="text-end"><span t-esc="format_amount(subtotal, o.currency_id)"/></td>
              </tr>
              <tr>
                <td>IVA (16%)</td>
                <td class="text-end"><span t-esc="format_amount(iva, o.currency_id)"/></td>
              </tr>
              <tr>
                <td><strong>Total</strong></td>
                <td class="text-end"><strong><span t-esc="format_amount(total, o.currency_id)"/></strong></td>
              </tr>
            </table>
            <p class="iva16-note">Cálculo visible solo en impresión/PDF. No impacta impuestos ni asientos contables en Odoo.</p>
          </div>
        </t>
      </xpath>
    </template>

    <!-- COMPRAS: misma lógica robusta -->
    <template id="purchase_report_iva_block" inherit_id="purchase.report_purchaseorder_document" priority="1012">
      <xpath expr="(//table[.//span[@t-field='o.amount_total'] or .//*[self::td or self::th][contains(normalize-space(), 'Total')]])[last()]" position="after">
        <t t-if="o">
          <style>
            @media screen { .iva16-block { display: none; } }
            @media print  { .iva16-block { display: block; } }
            .iva16-note { font-size: 11px; color: #666; }
            .iva16-table td { padding: 2px 0; }
          </style>

          <div class="iva16-block mt8">
            <t t-set="rate" t-value="0.16"/>
            <t t-set="subtotal" t-value="o.currency_id.round(o.amount_total / (1 + rate))"/>
            <t t-set="iva" t-value="o.currency_id.round(subtotal * rate)"/>
            <t t-set="total" t-value="subtotal + iva"/>

            <p class="mb4"><strong>Resumen (presentación con IVA 16%)</strong></p>
            <table class="table table-sm iva16-table" style="width:100%">
              <tr>
                <td>Subtotal</td>
                <td class="text-end"><span t-esc="format_amount(subtotal, o.currency_id)"/></td>
              </tr>
              <tr>
                <td>IVA (16%)</td>
                <td class="text-end"><span t-esc="format_amount(iva, o.currency_id)"/></td>
              </tr>
              <tr>
                <td><strong>Total</strong></td>
                <td class="text-end"><strong><span t-esc="format_amount(total, o.currency_id)"/></strong></td>
              </tr>
            </table>
            <p class="iva16-note">Cálculo visible solo en impresión/PDF. No impacta impuestos ni asientos contables en Odoo.</p>
          </div>
        </t>
      </xpath>
    </template>

  </data>
</odoo>